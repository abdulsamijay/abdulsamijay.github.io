<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Major DeFi hack analysis &amp; POCs" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction Defi hacks have become a major target for hackers to extract the value from the protocol with very little effort &amp; cost. In the web3 space it is very economically feasiblt to attack larger platforms &amp; disappear into the abyss of mixers." /><meta property="og:description" content="Introduction Defi hacks have become a major target for hackers to extract the value from the protocol with very little effort &amp; cost. In the web3 space it is very economically feasiblt to attack larger platforms &amp; disappear into the abyss of mixers." /><link rel="canonical" href="https://abdulsamijay.github.io/posts/defi-hack-analysis-poc/" /><meta property="og:url" content="https://abdulsamijay.github.io/posts/defi-hack-analysis-poc/" /><meta property="og:site_name" content="ASJ Blogs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-16T10:00:00+05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Major DeFi hack analysis &amp; POCs" /><meta name="twitter:site" content="@abdulsamijay" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-20T19:10:22+05:00","datePublished":"2022-07-16T10:00:00+05:00","description":"Introduction Defi hacks have become a major target for hackers to extract the value from the protocol with very little effort &amp; cost. In the web3 space it is very economically feasiblt to attack larger platforms &amp; disappear into the abyss of mixers.","headline":"Major DeFi hack analysis &amp; POCs","mainEntityOfPage":{"@type":"WebPage","@id":"https://abdulsamijay.github.io/posts/defi-hack-analysis-poc/"},"url":"https://abdulsamijay.github.io/posts/defi-hack-analysis-poc/"}</script><title>Major DeFi hack analysis & POCs | ASJ Blogs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ASJ Blogs"><meta name="application-name" content="ASJ Blogs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/images/wordle.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ASJ Blogs</a></div><div class="site-subtitle font-italic">Blogs focused on blockhain & security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/abdulsamijay" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/abdulsamijay" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','example.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Major DeFi hack analysis & POCs</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Major DeFi hack analysis & POCs</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1657947600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 16, 2022 </em> </span> <span> Updated <em class="" data-ts="1663683022" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 20, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/abdulsamijay">Abdul Sami J.</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2047 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h3 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Defi hacks have become a major target for hackers to extract the value from the protocol with very little effort &amp; cost. In the web3 space it is very economically feasiblt to attack larger platforms &amp; disappear into the abyss of mixers.</p><p>Here I discuss some the major defi hacks that took place in the past. We will analyze them to figure out what exactly went wrong. What strategies attackers normally take after exploiting a protocol.</p><p>In this blog post, I have compiled 10 defi hack analysis &amp; developed theri POCs for the purpose of understnding the mistakes that protocols made &amp; learn from it to avoid this the future. While developing the POCs I cam to realize that many of the exploits included <code class="language-plaintext highlighter-rouge">flashloan</code> + <code class="language-plaintext highlighter-rouge">re-entrancy</code> combination along with some incorrectly handled <code class="language-plaintext highlighter-rouge">access control mechanism</code>. I have also seen a few recent hacks that took place but haven’t created their POCs as they are pretty much the same to the exploits that I have written in this post. Going through the exploit repository you should be able to re-create those exploits as majority of them follows the same pattern.</p><p>I would aslo like to cateforize some hacks:</p><ol><li><code class="language-plaintext highlighter-rouge">Compromised</code> or leaked private keys {Keep the damn thing safe!}<li>Incorrect implementation of <code class="language-plaintext highlighter-rouge">Access control mechanism</code> in smart contracts which leads to ownership takeover.<li>Incorrect handling of <code class="language-plaintext highlighter-rouge">checks-effect-pattern</code> which causes <code class="language-plaintext highlighter-rouge">Re-entrancy attacks</code>.<li>Lack of <code class="language-plaintext highlighter-rouge">signature verification</code>, this applies to contracts that store the signature hash &amp; <code class="language-plaintext highlighter-rouge">cross-chain bridges</code>.<li>Unsafe usage of <code class="language-plaintext highlighter-rouge">Delegate</code> calls &amp; <code class="language-plaintext highlighter-rouge">Proxy</code> mechanism.<li><code class="language-plaintext highlighter-rouge">Oracle Manipulation</code> attacks.</ol><p><a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC"><code class="language-plaintext highlighter-rouge">Here is the repository for exploit re-creation</code></a>. You can follow the insturctions for running the exploits on forked enviroment.</p><h3 id="defi-exploit-pocs"><span class="mr-2">Defi Exploit POCs</span><a href="#defi-exploit-pocs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h3 id="the-infamous-daohack---the-classic-re-entrancy-2016"><span class="mr-2">The infamous DAOHack - The Classic Re-entrancy (2016)</span><a href="#the-infamous-daohack---the-classic-re-entrancy-2016" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This was a classic re-entrancy attack which led to the fork of <code class="language-plaintext highlighter-rouge">Ethereum</code> (ETH) &amp; <code class="language-plaintext highlighter-rouge">Ethereum-classic</code> (ETC) chain split. There was a debate on whether to fork the chain or not back in the day. This was I beleive the first attack in which the attacker managed to withdraw <code class="language-plaintext highlighter-rouge">3,800,000</code> (3.8 Million) Ether!</p><p>The core of the attak was:</p><ol><li>The contract sent Eth to the person buying &amp; deducted the balance after the transfer of Eth.<li>When the Eth is transfered to a function, it invokes the fallback function of the contract. Here the attcker used the opportunity to re-renter the function after depositing the amount.<li>The attcker repeatedly called the function in fallback &amp; withdrew <code class="language-plaintext highlighter-rouge">3.8 Million Ether</code>.<li>Therefore, Use the check-effect-pattern to migitage risks as such!</ol><p>See the <a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC/tree/master/src/The-Dao-hack">POC here</a>.</p><h3 id="beanstalk-finanace-hack-april-2022"><span class="mr-2">Beanstalk Finanace Hack (April, 2022)</span><a href="#beanstalk-finanace-hack-april-2022" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Beanstalk protocol got hacked for around $74M through exploiting the governance mechanism &amp; stealing all the BEANS &amp; Curve LP tokens stored in the Beanstalk protocol. It is a bit complex hack, lets break it down step by step.</p><ul><li><p><a href="https://etherscan.io/tx/0xcd314668aaa9bbfebaf1a0bd2b6553d01dd58899c508d4729fa7311dc5d33ad7">Hack Transaction</a></p><li><p><a href="https://etherscan.io/address/0x1c5dcdd006ea78a7e4783f9e6021c32935a10fb4">Hackers Address</a></p><li><p><a href="https://etherscan.io/address/0x79224bc0bf70ec34f0ef56ed8251619499a59def">Hacker Exploit Contract</a></p><li><p><a href="https://etherscan.io/address/0xe5ecf73603d98a0128f05ed30506ac7a663dbb69">Beanstalk Proposal Transaction</a></p></ul><ol><li>The attacker starts by taking a flashloan of $1 Billion from AAVE v2 containing the following assets.<ul><li><code class="language-plaintext highlighter-rouge">350,000,000</code> DAI<li><code class="language-plaintext highlighter-rouge">500,000,000</code> USDC<li><code class="language-plaintext highlighter-rouge">150,000,000</code> USDT</ul><li>The attacker takes yet another Flashloan from uniswap v2 for <code class="language-plaintext highlighter-rouge">32,100,950</code> BEAN &amp; Sushiswap for <code class="language-plaintext highlighter-rouge">11,643,065</code> LUSD.<li>Then the attacker deposits DAI, USDC &amp; USDT to Curves 3Pool (DAI/USDC/USDT) to get <code class="language-plaintext highlighter-rouge">979,691,328</code> 3Crv tokens.<li>Exchange <code class="language-plaintext highlighter-rouge">15,000,000</code> CRV tokens to <code class="language-plaintext highlighter-rouge">15,251,318</code> LUSD on BEANLUSD-f pool.<li>Add single asset liquidity 964,691,328 CRV to get <code class="language-plaintext highlighter-rouge">795,425,740</code> BEAN3CRV-f.<li>The attacker deposits <code class="language-plaintext highlighter-rouge">32,100,950</code> BEAN &amp; 26,894,383 LUSD to get <code class="language-plaintext highlighter-rouge">58,924,887</code> BEANLUSD-f<li>The user then deposits BEANLUSD-f &amp; BEAN3CRV-f to beanstalk contract to get enough voting power.<li>The attacker calls Diamond.vote(18) At this point user has control over 66% of voting power.<li>The proposal gets executed by calling the Diamond.emergencyCommit(18) function on beanstalk protocol which send back the following tokens back to the exploit contract.<ul><li><code class="language-plaintext highlighter-rouge">36,084,584</code> BEAN<li><code class="language-plaintext highlighter-rouge">0.540716100968756904</code> UNI-V2 ETH/BEAN.<li><code class="language-plaintext highlighter-rouge">874,663,982</code> BEAN3CRV-f.<li><code class="language-plaintext highlighter-rouge">60,562,844</code> BEANLUSD-f.<li><code class="language-plaintext highlighter-rouge">100</code> BEAN minted to the exploit contract.</ul><li>Removes <code class="language-plaintext highlighter-rouge">874,663,982</code> CRV single liquidity to get <code class="language-plaintext highlighter-rouge">1,007,734,729</code> CRV tokens.<li>Removes <code class="language-plaintext highlighter-rouge">60,562,844</code> BEANLUSD-f single liquidity to get <code class="language-plaintext highlighter-rouge">28,149,504</code> LUSD.<li>Returns flashloan of <code class="language-plaintext highlighter-rouge">11,678,100</code> LUSD to Sushiswap.<li>Returns flashloan of <code class="language-plaintext highlighter-rouge">32,197,543</code> BEAN to Uniswap V2.<li>Exchanges <code class="language-plaintext highlighter-rouge">16,471,404</code> LUSD to get <code class="language-plaintext highlighter-rouge">16,184,690</code> CRV on LUSDCRV-f.<li>Removes liquidity from <code class="language-plaintext highlighter-rouge">511,959,710</code> 3CRV Pool to get <code class="language-plaintext highlighter-rouge">522,487,380</code> USDC, <code class="language-plaintext highlighter-rouge">358,371,797</code> DAI, <code class="language-plaintext highlighter-rouge">156,732,232</code> USDT.<li>Returns flashloan on aave for 350,315,000 DAI, 500,450,000 USDC &amp; 150,135,000 USDT.<li>Removes liquidity on <code class="language-plaintext highlighter-rouge">0.540716100968756904</code> Uniswap V2 to get <code class="language-plaintext highlighter-rouge">10,883</code> Eth &amp; <code class="language-plaintext highlighter-rouge">32,511,085</code> BEAN.<li>Donated <code class="language-plaintext highlighter-rouge">250,000</code> USDC to Ukraine Donation Wallet.<li>Swap <code class="language-plaintext highlighter-rouge">15,443,059</code> DAI to <code class="language-plaintext highlighter-rouge">15,441,256</code> USDC on Uniswap V3.<li>Swap <code class="language-plaintext highlighter-rouge">37,228,637</code> USDC for <code class="language-plaintext highlighter-rouge">11,822</code> Eth on Uniswap V3.<li>Swap <code class="language-plaintext highlighter-rouge">6,597,232</code> USDT for <code class="language-plaintext highlighter-rouge">2,124</code> Eth on Uniswap V3.<li>Leaving the attacker with over <code class="language-plaintext highlighter-rouge">24k Eth</code> ~ <code class="language-plaintext highlighter-rouge">$72M</code> in profit.</ol><h4 id="the-exit-strategy"><span class="mr-2">THE EXIT STRATEGY</span><a href="#the-exit-strategy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The hacker used tornado cash &amp; split the ~24k Eth into chunks of 1, 10 &amp; 100 Eth to disappear in thin air. One thing to note is that this hack was a result of a bad governance design and not the economic design.</p><p>See the <a href="https://github.com/abdulsamijay/Beanstalk-Exploit-POC">POC here</a></p><h3 id="rari-capital-fuse-hack-april-2022"><span class="mr-2">Rari-Capital Fuse Hack (April, 2022)</span><a href="#rari-capital-fuse-hack-april-2022" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Rari capital got hacked for around $79M through a classic re-entrancy attack. Rari is a fork of compound finance which had this bug fixed earlier. It is not the first time Rari has been a victim of a hack.</p><h4 id="pre-requisite"><span class="mr-2">Pre-requisite</span><a href="#pre-requisite" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>Rari is a fork of compound finance &amp; compound had a known issue of re-entrancy attack whenever CTokens were borrowed through <code class="language-plaintext highlighter-rouge">borrow()</code> function.<li>This was patched by the Rari team by introducing a pool-wide re-entrancy guard on CTokens.<li>There also exists a component called “comptroller” which is responsible for functions such as providing &amp; withdrawing collateral by calling <code class="language-plaintext highlighter-rouge">enterMarkets()</code> &amp; exitMarket respectively.<li>The comptroller contract did not have re-entrancy checks in place. The attacker exploited through the <code class="language-plaintext highlighter-rouge">exitMarket()</code> function which makes the deposited asset no longer a collateral meaning it can be withdrawn at any time.</ol><h4 id="the-exploit"><span class="mr-2">The Exploit</span><a href="#the-exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The attacker created 2 contracts.</p><ol><li><a href="https://etherscan.io/address/0x32075bad9050d4767018084f0cb87b3182d36c45">For Exploiting Rari Fuse Pools</a><li><a href="https://etherscan.io/address/0xe39f3c40966df56c69aa508d8ad459e77b8a2bc1">For Receiving Profits after exploits</a></ol><p>There were 7 pools that were affected due to this exploit <code class="language-plaintext highlighter-rouge">(8，18，27，127，144，146，156)</code></p><ol><li>Attacker took flashloan of <code class="language-plaintext highlighter-rouge">50,000</code> WETH &amp; <code class="language-plaintext highlighter-rouge">80,000</code> WSTETH from Balancer vault<li>Attacker deposited <code class="language-plaintext highlighter-rouge">80,000</code> WSTETH collateral into fWSTETH-146 pool.<li>After depositing, the attacker borrowed <code class="language-plaintext highlighter-rouge">2397</code> ETH from fWSTETH-146 pool without updating the borrowers record.<li>The pool triggers the fallback function of the exploiter contract while sending ether to the exploit contract where the attacker makes a re-entrant call to <code class="language-plaintext highlighter-rouge">exitMarket()</code> &amp; withdraws his collateral of <code class="language-plaintext highlighter-rouge">80,000</code> WSTETH.<li>The attacker receives 2397 ETH for free &amp; transfers it to another contract for later claiming.<li>The attacker repeats steps 1–4 until all borrowed amount is collected.<li>The attacker applies the same strategy on 7 different pools &amp; runs away with <code class="language-plaintext highlighter-rouge">~$79M</code> of profit.</ol><p>See the <a href="https://github.com/abdulsamijay/Rari-Capital-Exploit-POC">Rari-Capital POC here</a></p><h3 id="wintermute-multisig-hack-june-2022"><span class="mr-2">Wintermute Multisig Hack (June, 2022)</span><a href="#wintermute-multisig-hack-june-2022" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This is attack that took place on <code class="language-plaintext highlighter-rouge">OPTIMISM</code> network. This POC continously creates proxy contracts to create wintermute multi-sig that had not been deployed to <code class="language-plaintext highlighter-rouge">optimism network</code> &amp; only existed on ethereum. The attacker took advantage of this as the <code class="language-plaintext highlighter-rouge">OPTIMISM</code> team gad already sent around <code class="language-plaintext highlighter-rouge">20M OP</code> tokens to this contract which hacker took custody of.</p><p>The attacker recursively generated addresses through the gnosis multisig until the address was generated allowing him to deploy contract at that particular address &amp; retrieved the tokens.</p><p>See the <a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC/tree/master/src/Optimism-Wintermute">Wintermute POC here</a>.</p><h3 id="xcarnival-nft-lending-protocol-hack-june-2022"><span class="mr-2">XCarnival NFT Lending Protocol Hack (June, 2022)</span><a href="#xcarnival-nft-lending-protocol-hack-june-2022" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A hack that took place on Ethereum Block <code class="language-plaintext highlighter-rouge">15028861</code>, where the hacker walked away with around <code class="language-plaintext highlighter-rouge">$3.8M</code> in ETH exploiting the XCarnival NFT Lending protocol.</p><ol><li>The attacker uses the <code class="language-plaintext highlighter-rouge">pledgeAndBorrow</code> function in the XNFT contract to use NFTs as collateral and borrow xToken.<li>Then, a call is made using the <code class="language-plaintext highlighter-rouge">withdrawNFT</code> function in order to extract the pledged NFT. This function first checks to see if the order has been closed. If it hasn’t, it checks to see if the NFT hasn’t been withdrawn and the loan amount is 0. If none of these conditions are met, it then determines that the NFT has not been withdrawn and the order is still active (no debt). NFTs that are used for collateral can be withdrawn.<li>The attack itself starts when the attacker uses the order to directly call the <code class="language-plaintext highlighter-rouge">borrow</code> function in the xToken contract.<li>Since the contract assumes the NFT has been already returned allow the attcker to withdraw more funds.<li>The essence of this vulnerability is that there is no check while borrowing to see whether the NFT in the order has been withdrawn, allowing an attacker to borrow without repayment after removing the NFT for their own benefit.</ol><p>See the <a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC/tree/master/src/XCarnival">XCarnival POC here</a>.</p><h3 id="pickle-finance-hack-nov-2020"><span class="mr-2">Pickle Finance Hack (Nov, 2020)</span><a href="#pickle-finance-hack-nov-2020" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>On 21st November 2021, Pickle finance was hacked, where an attacker was able to drain $19M DAI from the pDai jar. The attack exploited multiple inconsistencies &amp; flaws in the logic of the pickle jar smart contract.</p><h4 id="pre-requisite-1"><span class="mr-2">Pre-Requisite:</span><a href="#pre-requisite-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>Pickle Jar contract had a function <code class="language-plaintext highlighter-rouge">swapExactJarForJar()</code> which was meant to be generalized to bring more flexibility to the protocol. However, the attack could have been prevented if the function checked for whitelisted ones.<li>The attacker’s jars contain minimalist functions to function as a jar and since the user controls Jars most of the checks can be easily bypassed.</ol><h4 id="the-exploit-1"><span class="mr-2">The Exploit</span><a href="#the-exploit-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The user-created two Jar contracts</p><ol><li><a href="https://etherscan.io/address/0x2b0b02ce19c322b4dd55a3949b4fb6e9377f7913">Attackers Address</a><li><a href="https://etherscan.io/tx/0xe72d4e7ba9b5af0cf2a8cfb1e30fd9f388df0ab3da79790be842bfbed11087b0">Attack Transaction</a></ol><p>The attacker deploys two new fake Jars.</p><ul><li><a href="https://etherscan.io/address/0x75aa95508f019997aeee7b721180c80085abe0f9">First Jar</a><li><a href="https://etherscan.io/address/0x02c8364546ec849e1726fb6cae5228702b111ee6">Second Jar</a> <br /></ul><ol><li>The attacker calls strategyCmpdDaiV2.<code class="language-plaintext highlighter-rouge">getSuppliedUnleveraged()</code> which returns the amount of DAI available i.e <code class="language-plaintext highlighter-rouge">19728769153362174946836922</code> ~ <code class="language-plaintext highlighter-rouge">19M.728</code> DAI.<li>The attacker calls swapExactJarForJar the first time, supplying fake Jar addresses created earlier which withdraws deleveraged invested DAI from the compound back to pDAI Jar.<li>The Attacker calls <code class="language-plaintext highlighter-rouge">earn()</code> function 3 three times on pDAI (Pickling Dai) minting cDAI to StrategyCmpdDaiV2 contract.<li>The attacker deploys another two fake Jars &amp; a fake underlying.<ul><li><a href="https://etherscan.io/address/0xa2da08093a083c78c21aeca77d6fc89f3d545aed">Third Jar</a><li><a href="https://etherscan.io/address/0xa445e12d69e8bd60290f6935d49ff39ba31c6115">Fourth Jar</a><li><a href="https://etherscan.io/address/0x8739c55df8ca529dce060ed43279ea2f2e122122">Fake Underlying contract</a></ul><li>Then the attacker calls <code class="language-plaintext highlighter-rouge">swapExactJarForJar</code>, this time passes in the third &amp; fourth Jar with crafted data that makes a function call to curve proxy in the context of the controller-v4. Since the attacker has crafted the Jar to work with the contract it bypasses checks to the point where arbitrary code is executed in the context of the controller-v4 contract. Then <code class="language-plaintext highlighter-rouge">withdraw()</code> is called to withdraw <code class="language-plaintext highlighter-rouge">950,818,864</code> cDAI to controller-v4.<li>The withdrawn cDAI are deposited to the fake Jar through <code class="language-plaintext highlighter-rouge">deposit()</code> and all cDAI is transferred to the attacker.<li>The attacker calls <code class="language-plaintext highlighter-rouge">redeemUnderlying</code> on the compound to convert all cDAI to DAI &amp; walks away with <code class="language-plaintext highlighter-rouge">~19M DAI</code>.</ol><p>Here is the <a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC/blob/master/src/pickle-finance">Pickle Finance Hack POC</a></p><h3 id="harvest-finance-hack-october-2020"><span class="mr-2">Harvest Finance Hack (October, 2020)</span><a href="#harvest-finance-hack-october-2020" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Harvest finance got hacked for around <code class="language-plaintext highlighter-rouge">$34M</code> due to a flashloan attack which <code class="language-plaintext highlighter-rouge">manipulated the price</code> in the Curve pool to retrieve more USDT tokens than originally deposited USDT amount in fUSDT pool. This attack was also possible on other f-pools using the same set of steps described below. But the attacker chose not to continue. If the attack had continued, the attacker would have walked away with <code class="language-plaintext highlighter-rouge">~$400M</code> worth of assets.</p><ol><li>The attacker deploys a contract &amp; pre-funds it with <code class="language-plaintext highlighter-rouge">10.69M</code> USDT &amp; <code class="language-plaintext highlighter-rouge">11.435M</code> USDC<li>The attacker took flashloan of <code class="language-plaintext highlighter-rouge">50M</code> USDT from the Uniswap v2 USDT-WETH pair.<li>The attacker then swaps <code class="language-plaintext highlighter-rouge">11.425M</code> USDC for <code class="language-plaintext highlighter-rouge">11.407M</code> USDT. Now the contract has <code class="language-plaintext highlighter-rouge">60.66M</code> USDT.<li>A total of <code class="language-plaintext highlighter-rouge">60.66M</code> USDT are then deposited to the fUSDT pool to get <code class="language-plaintext highlighter-rouge">71668595794204</code> fUSDT tokens.<li>The attacker then swaps <code class="language-plaintext highlighter-rouge">11.437M</code> USDT back for USDC.<li>The attacker withdraws the deposited fUSDT to claim <code class="language-plaintext highlighter-rouge">61.1M</code> USDT which is more than what was originally deposited i.e <code class="language-plaintext highlighter-rouge">60.6M</code> USDT.<li>Gaining profit of approximately <code class="language-plaintext highlighter-rouge">0.5M</code>. The attacker repeatedly called steps 3-6 4 times to gain profit.</ol><p>See the <a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC/tree/master/src/harvest-finance">Harvest Finance Hack here</a></p><h3 id="inverse-finance-hack-june-2022"><span class="mr-2">Inverse finance Hack (June 2022)</span><a href="#inverse-finance-hack-june-2022" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Inver finance was hit by the attcker in mid June 2022, and is the classic example of oracle manipulation. The attackers managed to steal ~6M worth of tokens.</p><p>I have omitted the detailed steps for the eploit which I belive are easily understood by taking look at the code. As hervest finance attack was similar to it.</p><p>Check out the <a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC/tree/master/src/Inverse-finanace">Inverse Hack POC here</a></p><h3 id="honorable-mentions"><span class="mr-2">Honorable Mentions</span><a href="#honorable-mentions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h3 id="the-infamous-accidently-killed-it-july-2017"><span class="mr-2">The infamous ‘Accidently killed it’ (July, 2017)</span><a href="#the-infamous-accidently-killed-it-july-2017" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A person was experimenting with the newly deployed wallet for parity. And this person accidently killed it be becomming the owner &amp; calling <code class="language-plaintext highlighter-rouge">self-destruct</code> on the contract. Whether it was intentional or a mistake remains a mystery! Though this was not exactly a hack but it qualified in my honorable mentions list.</p><p>Here is the github <a href="https://github.com/openethereum/parity-ethereum/issues/6995">issue</a>.</p><p>See the <a href="https://github.com/abdulsamijay/Defi-Hack-Analysis-POC/tree/master/src/The-Praity-Kill">TheParityKill POC here</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-analysis/'>hack-analysis</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/exploit/" class="post-tag no-text-decoration" >exploit</a> <a href="/tags/defi-securiry/" class="post-tag no-text-decoration" >defi-securiry</a> <a href="/tags/poc/" class="post-tag no-text-decoration" >poc</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Major+DeFi+hack+analysis+%26+POCs+-+ASJ+Blogs&url=https%3A%2F%2Fabdulsamijay.github.io%2Fposts%2Fdefi-hack-analysis-poc%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Major+DeFi+hack+analysis+%26+POCs+-+ASJ+Blogs&u=https%3A%2F%2Fabdulsamijay.github.io%2Fposts%2Fdefi-hack-analysis-poc%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fabdulsamijay.github.io%2Fposts%2Fdefi-hack-analysis-poc%2F&text=Major+DeFi+hack+analysis+%26+POCs+-+ASJ+Blogs" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/my-paradigm-ctf-2022-write-up/">My Paradigm CTF 2022 write-ups</a><li><a href="/posts/fuzzing-property-testing/">Property-based testing & fuzzing smart contracts</a><li><a href="/posts/defi-hack-analysis-poc/">Major DeFi hack analysis & POCs</a><li><a href="/posts/ethernaut-writeups/">Solutions to Ethernaut Challenges</a><li><a href="/posts/ride-to-open-source-contribution/">A Roller-Coaster Ride to Open-Source Contribution in Ethereum 2.0</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/solidity/">solidity</a> <a class="post-tag" href="/tags/ethereum/">ethereum</a> <a class="post-tag" href="/tags/evm/">EVM</a> <a class="post-tag" href="/tags/smart-contracts/">smart contracts</a> <a class="post-tag" href="/tags/challenge/">challenge</a> <a class="post-tag" href="/tags/client/">client</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/defi-securiry/">defi-securiry</a> <a class="post-tag" href="/tags/eth-2-0/">eth 2.0</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/my-paradigm-ctf-2022-write-up/"><div class="card-body"> <em class="small" data-ts="1661662800" data-df="ll" > Aug 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>My Paradigm CTF 2022 write-ups</h3><div class="text-muted small"><p> Paradigm CTF ? Paradigm hosted a CTF this year named Paradigm CTF 2022. It is an online competition organized for blockchain devs, smart contract devs &amp;amp; hackers. It was also conducted last year...</p></div></div></a></div><div class="card"> <a href="/posts/ethernaut-writeups/"><div class="card-body"> <em class="small" data-ts="1653282000" data-df="ll" > May 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Solutions to Ethernaut Challenges</h3><div class="text-muted small"><p> Introduction Ethernaut is a wonderful website based game developed by Openzeppelin and played in Ethereum virtual machine. Each level is a smart contract that needs to be ‘hacked’. This game provi...</p></div></div></a></div><div class="card"> <a href="/posts/fuzzing-property-testing/"><div class="card-body"> <em class="small" data-ts="1650344400" data-df="ll" > Apr 19, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Property-based testing & fuzzing smart contracts</h3><div class="text-muted small"><p> Introduction Property-based testing is described as a testing philosophy which targets all types of testing including unit, acceptance &amp;amp; integration testing. It was mainly standardized and prop...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ethernaut-writeups/" class="btn btn-outline-primary" prompt="Older"><p>Solutions to Ethernaut Challenges</p></a> <a href="/posts/my-paradigm-ctf-2022-write-up/" class="btn btn-outline-primary" prompt="Newer"><p>My Paradigm CTF 2022 write-ups</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/abdulsamijay">Abdul Sami J.</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/solidity/">solidity</a> <a class="post-tag" href="/tags/ethereum/">ethereum</a> <a class="post-tag" href="/tags/evm/">EVM</a> <a class="post-tag" href="/tags/smart-contracts/">smart contracts</a> <a class="post-tag" href="/tags/challenge/">challenge</a> <a class="post-tag" href="/tags/client/">client</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/defi-securiry/">defi-securiry</a> <a class="post-tag" href="/tags/eth-2-0/">eth 2.0</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
